<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireGuard Ultra | Real-Time Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>
<body class="bg-black text-slate-100 font-sans antialiased">

    <div class="bg-red-600 text-white text-[10px] font-black uppercase tracking-[0.3em] py-1 text-center">
        High-Speed Monitoring Active â€¢ 10s Grace Period Enabled
    </div>

    <header class="bg-zinc-900/50 border-b border-white/10 p-6 sticky top-0 z-50 backdrop-blur-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="h-3 w-3 rounded-full bg-red-500 animate-pulse shadow-[0_0_10px_red]"></div>
                <h1 class="text-xl font-black tracking-widest uppercase">System <span class="text-red-500">Overview</span></h1>
            </div>
            <div id="clock" class="font-mono text-slate-400 text-sm">--:--:--</div>
        </div>
    </header>

    <main class="container mx-auto p-6 max-w-5xl">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div id="card-Building_1" class="bg-zinc-900 border border-white/5 rounded-sm p-6 transition-all duration-200">
                <div class="flex justify-between border-b border-white/5 pb-4 mb-6">
                    <h2 class="text-2xl font-black uppercase italic">Building 01</h2>
                    <span id="conn-Building_1" class="text-[10px] px-2 py-1 bg-zinc-800 rounded font-bold">WAITING</span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-black p-4 border-l-2 border-blue-500">
                        <p class="text-[10px] uppercase text-slate-500 font-bold">Smoke Level</p>
                        <p id="smoke-Building_1" class="text-4xl font-mono">---</p>
                    </div>
                    <div id="fire-bg-Building_1" class="bg-black p-4 border-l-2 border-zinc-800 transition-all duration-150">
                        <p class="text-[10px] uppercase text-slate-500 font-bold">Fire Sensor</p>
                        <p id="fire-Building_1" class="text-lg font-bold">STBY</p>
                    </div>
                </div>

                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-mono text-slate-500 uppercase">
                        <span>Last Sync</span>
                        <span id="time-Building_1">--:--:--</span>
                    </div>
                    <div class="w-full bg-zinc-800 h-1 mt-2">
                        <div id="bar-Building_1" class="bg-green-500 h-full transition-all duration-1000" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div id="card-Building_2" class="bg-zinc-900 border border-white/5 rounded-sm p-6 transition-all duration-200">
                <div class="flex justify-between border-b border-white/5 pb-4 mb-6">
                    <h2 class="text-2xl font-black uppercase italic">Building 02</h2>
                    <span id="conn-Building_2" class="text-[10px] px-2 py-1 bg-zinc-800 rounded font-bold">WAITING</span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-black p-4 border-l-2 border-blue-500">
                        <p class="text-[10px] uppercase text-slate-500 font-bold">Smoke Level</p>
                        <p id="smoke-Building_2" class="text-4xl font-mono">---</p>
                    </div>
                    <div id="fire-bg-Building_2" class="bg-black p-4 border-l-2 border-zinc-800 transition-all duration-150">
                        <p class="text-[10px] uppercase text-slate-500 font-bold">Fire Sensor</p>
                        <p id="fire-Building_2" class="text-lg font-bold">STBY</p>
                    </div>
                </div>

                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-mono text-slate-500 uppercase">
                        <span>Last Sync</span>
                        <span id="time-Building_2">--:--:--</span>
                    </div>
                    <div class="w-full bg-zinc-800 h-1 mt-2">
                        <div id="bar-Building_2" class="bg-green-500 h-full transition-all duration-1000" style="width: 100%"></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBqZNHYAQ8_O9yqcVrMkP7um9L62Cpi4y0",
            databaseURL: "fire-detector-8c8bd-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fire-detector-8c8bd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- STRICTOR GRACE PERIOD ---
        const GRACE_PERIOD_MS = 20000; // 10 Seconds

        const buildings = ["Building_1", "Building_2"];
        const state = { Building_1: {}, Building_2: {} };

        // Update Global Clock
        setInterval(() => {
            document.getElementById('clock').innerText = moment().format('HH:mm:ss');
            // Re-run status check for both buildings every second to handle timeout
            buildings.forEach(id => checkTimeout(id));
        }, 1000);

        buildings.forEach(id => {
            onValue(ref(db, '/' + id), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state[id] = data;
                    updateDataUI(id, data);
                }
            });
        });

        function updateDataUI(id, data) {
            document.getElementById(`smoke-${id}`).innerText = data.smoke || 0;
            const fireEl = document.getElementById(`fire-${id}`);
            const fireBg = document.getElementById(`fire-bg-${id}`);

            if (data.fire === true) {
                fireEl.innerText = "FIRE ALERT";
                fireEl.classList.add("text-red-500");
                fireBg.className = "bg-red-900/20 p-4 border-l-2 border-red-500 animate-pulse";
            } else {
                fireEl.innerText = "CLEAR";
                fireEl.classList.remove("text-red-500");
                fireEl.classList.add("text-green-500");
                fireBg.className = "bg-black p-4 border-l-2 border-green-500";
            }
            document.getElementById(`time-${id}`).innerText = moment(data.last_seen).format('HH:mm:ss');
        }

        function checkTimeout(id) {
            const data = state[id];
            if (!data || !data.last_seen) return;

            const diff = Date.now() - Number(data.last_seen);
            const connEl = document.getElementById(`conn-${id}`);
            const bar = document.getElementById(`bar-${id}`);
            const card = document.getElementById(`card-${id}`);

            // Calculate percentage of 10s remaining for the visual bar
            let percent = Math.max(0, 100 - (diff / GRACE_PERIOD_MS * 100));
            bar.style.width = percent + "%";

            if (diff < GRACE_PERIOD_MS) {
                connEl.innerText = "LIVE SIGNAL";
                connEl.className = "text-[10px] px-2 py-1 bg-green-900 text-green-400 rounded font-bold";
                bar.className = "bg-green-500 h-full transition-all duration-1000";
                card.style.borderColor = "rgba(255,255,255,0.05)";
            } else {
                connEl.innerText = "SIGNAL LOST";
                connEl.className = "text-[10px] px-2 py-1 bg-red-900 text-red-400 rounded font-bold animate-bounce";
                bar.className = "bg-red-500 h-full transition-all duration-1000";
                card.style.borderColor = "red";
            }
        }
    </script>
</body>
</html>
